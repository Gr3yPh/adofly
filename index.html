<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <style>
        @font-face {
            font-family: NaiKaiFont;
            src: url('NaiKaiFont.ttf');
        }

        body {
            text-align: center;
        }

        * {
            font-family: NaiKaiFont;
        }
    </style>
    <title>Adofly 0.1</title>
</head>

<body>
    <h1>Adofly</h1>
    <p>用爱发电的冰与火之舞社区版游戏，仍在开发，特抽象</p>
    <p>Made by 魇珩Gr3yPh4nton http://gr3yph.gt.tc</p>
    <canvas id="gameCanvas" width="800" height="500" style="background-color: black;">
    </canvas>

    <script>
        var angle = 180;
        var bpm = 80;
        var isReady = false;
        var isPlaying = false;
        var isFinished = false;
        var isFailed = false;
        var angleData = [0, 90, 180, 90, 0, 90, 180, 90, 0, 90, 180, 90, 0, 90, 180, 90, 0, 90, 180, 90, 0, 90, 180, 90, 0, 90, 180, 90, 0];
        angleData.push(angleData.at(-1));
        var ballColor1 = 'red';
        var ballColor2 = 'blue';
        var counterclock = false;
        var x_start = 400 - 25;
        var y_start = 250;
        var current_rail = 0;
        var start_time;
        var actions = [
            { "floor": 3, "eventType": "Twirl" },
            { "floor": 5, "eventType": "Twirl" },
            { "floor": 7, "eventType": "Twirl" },
            { "floor": 9, "eventType": "Twirl" },
            { "floor": 11, "eventType": "Twirl" },
            { "floor": 13, "eventType": "Twirl" },
            { "floor": 15, "eventType": "Twirl" },
            { "floor": 17, "eventType": "Twirl" },
            { "floor": 19, "eventType": "Twirl" },
            { "floor": 21, "eventType": "Twirl" },
            { "floor": 23, "eventType": "Twirl" },
            { "floor": 25, "eventType": "Twirl" },
            { "floor": 27, "eventType": "Twirl" }
        ];
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        const reversion = new Image();
        reversion.src = 'image/counterclock.png';
        const rabbit = new Image();
        rabbit.src = 'image/rabbit.png';
        const snail = new Image();
        snail.src = 'image/snail.png';

        function drawRails() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.beginPath();
            ctx.strokeStyle = '#fca607';
            ctx.lineWidth = 25;
            var x = x_start;
            var y = y_start;
            var currentAngle = 0;
            var currentRail = 0;
            angleData.forEach(railAngle => {
                ctx.moveTo(x, y);
                drawLineAngle(currentAngle, x, y, 25);
                x = x + 25 * Math.cos(currentAngle / 180 * Math.PI);
                y = y - 25 * Math.sin(currentAngle / 180 * Math.PI);
                drawLineAngle(railAngle, x, y, 25);
                x = x + 25 * Math.cos(railAngle / 180 * Math.PI);
                y = y - 25 * Math.sin(railAngle / 180 * Math.PI);
                //ctx.moveTo(x + 2, y);
                //ctx.lineTo(x + 50 - 2, y);
                //x += 50;
                currentAngle = railAngle;
            });
            var x = x_start;
            var y = y_start;
            var currentAngle = 0;
            ctx.stroke();
            angleData.forEach(railAngle => {
                x = x + 25 * Math.cos(currentAngle / 180 * Math.PI);
                y = y - 25 * Math.sin(currentAngle / 180 * Math.PI);
                actions.forEach(function (item) {
                    if (currentRail == item.floor) {
                        if (item.eventType == 'Twirl') {
                            ctx.drawImage(reversion, x - 13, y - 13, 25, 25);
                        } else if (item.eventType = 'SetSpeed') {
                            if (item.speedType == 'Multiplier') {
                                if (item.bpmMultiplier > 1) {
                                    ctx.drawImage(rabbit, x - 13, y - 13, 25, 25);
                                }
                                else {
                                    ctx.drawImage(snail, x - 13, y - 13, 25, 25);
                                }
                            } else {
                                if (item.beatsPerMinute > bpm) {
                                    ctx.drawImage(rabbit, x - 13, y - 13, 25, 25);
                                } else {
                                    ctx.drawImage(snail, x - 13, y - 13, 25, 25);
                                }
                            }
                        }
                    }
                    if (currentRail == angleData.length - 1) {
                        ctx.beginPath();
                        ctx.arc(x, y, 13, 0, Math.PI * 2);
                        ctx.fillStyle = 'white';
                        ctx.fill();
                    }
                })
                x = x + 25 * Math.cos(railAngle / 180 * Math.PI);
                y = y - 25 * Math.sin(railAngle / 180 * Math.PI);
                currentAngle = railAngle;
                currentRail++;
            });
        }

        function drawLineAngle(angle, x_begin, y_begin, len) {
            angle = angle / 180 * Math.PI;
            x_end = x_begin + len * Math.cos(angle);
            y_end = y_begin - len * Math.sin(angle);
            ctx.lineTo(x_end, y_end);
        }

        function drawBalls() {
            ctx.beginPath();
            ctx.arc(400, 250, 13, 0, Math.PI * 2);
            ctx.fillStyle = ballColor1;
            ctx.fill();

            ctx.beginPath();
            if (!counterclock) {
                ctx.arc(400 - 50 * Math.cos(angle), 250 - 50 * Math.sin(angle), 13, 0, Math.PI * 2);
            }
            else {
                ctx.arc(400 - 50 * Math.cos(angle), 250 + 50 * Math.sin(angle), 13, 0, Math.PI * 2);
            }
            ctx.fillStyle = ballColor2;
            ctx.fill();
        }

        function ballLoop() {
            if (isReady) {
                angle += Math.PI / 180 * 10;
                drawRails();
                drawBalls();
                if (!isFinished) {
                    if (Date.now() - start_time <= 1000 * (60 / bpm)) {
                        ctx.font = '50px NaiKaiFont';
                        ctx.fillStyle = 'white';
                        ctx.textAlign = 'center';
                        ctx.baseLine = 'middle';
                        ctx.fillText('3', 400, 250);
                    } else if (Date.now() - start_time <= 2000 * (60 / bpm)) {
                        ctx.font = '50px NaiKaiFont';
                        ctx.fillStyle = 'white';
                        ctx.textAlign = 'center';
                        ctx.baseLine = 'middle';
                        ctx.fillText('2', 400, 250);
                    } else if (Date.now() - start_time <= 3000 * (60 / bpm)) {
                        ctx.font = '50px NaiKaiFont';
                        ctx.fillStyle = 'white';
                        ctx.textAlign = 'center';
                        ctx.baseLine = 'middle';
                        ctx.fillText('1', 400, 250);
                    } else if (Date.now() - start_time <= 4000 * (60 / bpm)) {
                        ctx.font = '50px NaiKaiFont';
                        ctx.fillStyle = 'white';
                        ctx.textAlign = 'center';
                        ctx.baseLine = 'middle';
                        ctx.fillText('开始！', 400, 250);
                    } else {
                        isPlaying = true;
                    }
                }else{
                    ctx.font = '50px NaiKaiFont';
                    ctx.fillStyle = 'white';
                    ctx.textAlign = 'center';
                    ctx.baseLine = 'middle';
                    ctx.fillText('恭喜！', 400, 250);
                }
            } else {
                ctx.font = '50px NaiKaiFont';
                ctx.fillStyle = 'white';
                ctx.textAlign = 'center';
                ctx.baseLine = 'middle';
                ctx.fillText('点击开始', 400, 250);
            }
            setTimeout(ballLoop, 10000 / (3 * bpm));
        }
        document.addEventListener('keydown', function (event) {
            switchBall();
        });
        canvas.addEventListener('click', function (event) { switchBall(); })
        function switchBall() {
            if (!isReady) { isReady = true; start_time = Date.now(); }
            if (!isPlaying) return;
            if (current_rail > angleData.length - 2) return;
            if (ballColor1 == 'red') {
                ballColor1 = 'blue';
                ballColor2 = 'red';
            } else {
                ballColor1 = 'red';
                ballColor2 = 'blue';
            }
            x_start -= Math.cos(angleData[current_rail] / 180 * Math.PI) * 50;
            y_start += Math.sin(angleData[current_rail] / 180 * Math.PI) * 50;
            if (!counterclock) {
                angle = -angleData[current_rail];
            } else {
                angle = angleData[current_rail];
            }
            current_rail += 1;
            actions.forEach(function (item) {
                if (current_rail == item.floor) {
                    if (item.eventType == 'Twirl') {
                        if (counterclock) {
                            counterclock = false;
                        } else {
                            counterclock = true;
                        }
                    } else if (item.eventType == 'SetSpeed') {
                        if (item.speedType == 'Multiplier') {
                            bpm = bpm * item.bpmMultiplier;
                        } else {
                            bpm = item.beatsPerMinute;
                        }
                    }
                }
            })
            if (current_rail == angleData.length - 1) {
                isFinished = true;
                isPlaying = false;
            }
        }

        ballLoop();

    </script>
</body>

</html>